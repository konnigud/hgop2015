var should = require('should');

module.exports = function tictactoeCommandHandler(events){
    var gameCreatedEvent = events;



    var handlers = {
        "CreateGame":function(cmd){
            var newGame={
                id:cmd.id,
                playerOne:cmd.userName,
                createTimeStamp:cmd.timeStamp,
                name:cmd.name,
            };
            gameCreatedEvent.push(cmd);
            return [{
                id: cmd.id,
                event: "GameCreated",
                gameId: gameCreatedEvent.length,
                userName: cmd.userName,
                timeStamp: cmd.timeStamp,
                name: cmd.name
            }];
        },
        "JoinGame":function(cmd){
            var game;
            try {
                game = getGame(cmd);
            }
            catch(err){
                return err;
            }
            if(game.playerTwo===undefined) {
                game.playerTwo = cmd.userName;
                return [{
                    id: cmd.id,
                    event: "GameJoined",
                    gameId:game.gameId,
                    playerOne: game.playerOne,
                    playerTwo: game.playerTwo,
                    timeStamp: cmd.timeStamp
                }];
            }
            return[{
                id:cmd.id,
                event:"GameIsFull",
                gameId:game.gameId,
                userName:cmd.userName,
                timeStamp:cmd.timeStamp
            }];
        },
        "MakeMove":function(cmd){
            var game;
            try {
                game = getGame(cmd);
            }
            catch(err){
                return err;
            }

            return [{}];
        }
    };

    var getGame = function(cmd){
        if(gameCreatedEvent===undefined || cmd.gameId > gameCreatedEvent.length){
            throw [{
                id:cmd.id,
                event:"GameDoesNotExist",
                userName: cmd.userName,
                timeStamp: cmd.timeStamp
            }];
        }
        else {
            var game = gameCreatedEvent[cmd.gameId-1];
            game.gameId = cmd.gameId;
            return game;
        }
    }

    return {
        executeCommand:function(cmd){
            return handlers[cmd.comm](cmd);
        }
    };
}